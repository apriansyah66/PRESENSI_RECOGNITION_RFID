<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Absensi Face Recognition</title>

<!-- pastikan ini di HEAD -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
body {text-align:center;background:#eef;padding:20px;font-family:sans-serif;}
video {border:1px solid #333;border-radius:8px;margin-top:10px;}
</style>
</head>

<body>
<h2>📋 Absensi Wajah + RFID</h2>

<div>
  UID RFID: <span id="uid">menunggu...</span>
</div>

<video id="video" width="320" height="240" autoplay muted></video><br>
<p id="status">📷 Memuat model & data wajah...</p>

<!-- Pindahkan skrip Anda ke sini supaya setelah faceapi diload -->
<script>
window.addEventListener('DOMContentLoaded', () => {
const video = document.getElementById('video');
const statusEl = document.getElementById('status');

// polling RFID UID
setInterval(async () => {
  try {
    const res = await fetch('absennn.php');
    const data = await res.json();
    if (data.tampilkan_card) {
      document.getElementById('uid').textContent = data.rfid_uid;
    }
  } catch (err) {
    console.error('Gagal polling RFID:', err);
  }
}, 2000);

// mulai kamera
navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{
  video.srcObject=stream;
});

// load face-api.js models
Promise.all([
  faceapi.nets.tinyFaceDetector.loadFromUri('./models'),
  faceapi.nets.faceRecognitionNet.loadFromUri('./models'),
  faceapi.nets.faceLandmark68Net.loadFromUri('./models')
]).then(() => {
  console.log('✅ Semua model sudah dimuat');
  startRecognition();
}).catch(err => {
  console.error('❌ Gagal memuat model:', err);
  statusEl.textContent = '❌ Gagal memuat model';
});

async function loadLabeledImages() {
  const labels = ['Apri', 'Budi'];
  return Promise.all(
    labels.map(async label => {
      const descriptions = [];
      for (let i = 1; i <= 2; i++) {
        const img = await faceapi.fetchImage(`./known_faces/${label}/${i}.jpg`);
        const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
        if (detection) {
          descriptions.push(detection.descriptor);
        } else {
          console.warn(`Wajah tidak terdeteksi pada ${label}/${i}.jpg`);
        }
      }
      return new faceapi.LabeledFaceDescriptors(label, descriptions);
    })
  );
}

async function startRecognition() {
  const labeledDescriptors = await loadLabeledImages();
  const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
  statusEl.textContent = '✅ Siap untuk absensi';

  const canvas = faceapi.createCanvasFromMedia(video);
  document.body.append(canvas);
  const displaySize = { width: video.width, height: video.height };
  faceapi.matchDimensions(canvas, displaySize);

  setInterval(async () => {
    const uid = document.getElementById('uid').textContent;
    if (uid === 'menunggu...') {
      statusEl.textContent = '🔄 Menunggu kartu RFID...';
      return;
    }

    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks().withFaceDescriptors();

    const resizedDetections = faceapi.resizeResults(detections, displaySize);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    faceapi.draw.drawDetections(canvas, resizedDetections);

    resizedDetections.forEach(d => {
      const bestMatch = faceMatcher.findBestMatch(d.descriptor);
      const box = d.detection.box;
      const drawBox = new faceapi.draw.DrawBox(box, {label: bestMatch.toString()});
      drawBox.draw(canvas);

      if (bestMatch.label !== 'unknown') {
        statusEl.textContent = `📌 ${bestMatch.label} terdeteksi, kirim absensi...`;
        sendAttendance(uid, bestMatch.label);
      } else {
        statusEl.textContent = '🚫 Wajah tidak dikenali.';
      }
    });
  }, 2000);
}

async function sendAttendance(uid, name) {
  try {
    const res = await fetch('submit_absen.php', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: `uid=${encodeURIComponent(uid)}&name=${encodeURIComponent(name)}`
    });
    const msg = await res.text();
    statusEl.textContent = msg;
  } catch (err) {
    console.error('❌ Gagal kirim absensi:', err);
    statusEl.textContent = '❌ Gagal kirim absensi';
  }
}
});
</script>
</body>
</html>
